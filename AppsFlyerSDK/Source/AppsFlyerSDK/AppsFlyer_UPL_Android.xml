<root xmlns:android="http://schemas.android.com/apk/res/android">
    <buildGradleAdditions>
        <insert>
            repositories {
                mavenCentral()
            }
            dependencies {
                implementation 'com.android.installreferrer:installreferrer:2.2'
                implementation 'com.appsflyer:af-android-sdk:6.17.5'
            }
            android {
                compileOptions {
                    sourceCompatibility 1.8
                    targetCompatibility 1.8
                }
            }
        </insert>
    </buildGradleAdditions>
        <!--  optional app build.gradle additions -->
    <buildscriptGradleAdditions>
    <insert>
        repositories {
            mavenCentral()
        }
    </insert>
    </buildscriptGradleAdditions>
    <gradleProperties>
        <insert>
            org.gradle.jvmargs='-Dfile.encoding=UTF-8'
        </insert>
    </gradleProperties>
    <androidManifestUpdates>
        <addPermission android:name="android.permission.INTERNET" />
        <addPermission android:name="android.permission.ACCESS_NETWORK_STATE" />
    </androidManifestUpdates>
    <gameActivityImportAdditions>
        <insert>
            import android.app.Application;
            import com.appsflyer.*;
            import com.appsflyer.internal.platform_extension.Plugin;
            import com.appsflyer.internal.platform_extension.PluginInfo;
            import java.util.HashMap;
            import java.util.Map;

            import com.appsflyer.AFAdRevenueData;
            import com.appsflyer.MediationNetwork;
            import com.appsflyer.AppsFlyerLib;

            import java.util.Currency;

            import android.util.Log;
        </insert>
    </gameActivityImportAdditions>
    <gameActivityClassAdditions>
        <insert>
            private String afKey;

            public void afStart(String key, boolean isDebug) {
                afKey = key;
                AppsFlyerLib appsflyer = AppsFlyerLib.getInstance();
                appsflyer.setDebugLog(isDebug);
                appsflyer.init(key, new AppsFlyer2dXConversionCallback(), this)
                        .start(this);
            }

            public void afSetCustomerUserId(String id) {
                AppsFlyerLib.getInstance().setCustomerUserId(id);
            }

            public void afStartLaunch() {
                AppsFlyerLib.getInstance().start(this, afKey);
            }

            public void afLogEvent(String eventName, Map&lt;String, Object&gt; eventValues) {
                AppsFlyerLib.getInstance().logEvent(this, eventName, eventValues);
            }

            public String afGetAppsFlyerUID() {
                return AppsFlyerLib.getInstance().getAppsFlyerUID(this);
            }

            public void afSetAdditionalData(Map&lt;String, Object&gt; customData) {
                AppsFlyerLib.getInstance().setAdditionalData(customData);
            }

            public void afSetPluginInfo(String pluginVersion, String engineVersion) {
                
                Map&lt;String, String&gt; additionalData = new HashMap&lt;String,String&gt;();
                additionalData.put("engine_version", engineVersion);

                PluginInfo pluginInfo = new PluginInfo(Plugin.UNREAL, pluginVersion, additionalData);
                AppsFlyerLib.getInstance().setPluginInfo(pluginInfo);   
            }

            public void afEnableTCFDataCollection(boolean isTCFDataCollectionEnabled) {
                AppsFlyerLib.getInstance().enableTCFDataCollection(isTCFDataCollectionEnabled);
            }

            public void afDisableAppSetId() {
                AppsFlyerLib.getInstance().disableAppSetId();
            }

            public void afLogAdRevenue(
                String monetizationNetwork,
                int mediationNetwork,
                double revenue,
                String currency,
                Map<String, String> customData)
            {
                AFAdRevenueData adRevenueData = new AFAdRevenueData(monetizationNetwork, getAFMediationNetwork(mediationNetwork), currency, revenue);
    
                Map<String, Object> additionalParameters = new HashMap<>();
    
                if(customData.containsKey("Country")) additionalParameters.put(AdRevenueScheme.COUNTRY, customData.get("Country"));
                if(customData.containsKey("UnitID")) additionalParameters.put(AdRevenueScheme.AD_UNIT, customData.get("UnitID"));
                if(customData.containsKey("AdType")) additionalParameters.put(AdRevenueScheme.AD_TYPE, customData.get("AdType"));
                if(customData.containsKey("Placement")) additionalParameters.put(AdRevenueScheme.PLACEMENT, customData.get("Placement"));
    
                AppsFlyerLib.getInstance().logAdRevenue(adRevenueData, additionalParameters);
    
                Log.debug("AppsflyerLog Track ad revenue");
            }

            // Deprecated
            public void afSetConsentData(boolean isGDPR, boolean hasConsentForDataUsage, boolean hasConsentForAdsPersonalization) {
                AppsFlyerConsent consent;
                if (isGDPR == true) {
                    consent = AppsFlyerConsent.forGDPRUser(hasConsentForDataUsage, hasConsentForAdsPersonalization);
                } else {
                    consent = AppsFlyerConsent.forNonGDPRUser();
                }
                   
                AppsFlyerLib.getInstance().setConsentData(consent);
            }

            public void appsflyer_set_consent_v2(Boolean isUserSubjectToGDPR,
                                                 Boolean hasConsentForDataUsage,
                                                 Boolean hasConsentForAdsPersonalization,
                                                 Boolean hasConsentForAdStorage) {
                AppsFlyerConsent consent = new AppsFlyerConsent(
                    isUserSubjectToGDPR,
                    hasConsentForDataUsage,
                    hasConsentForAdsPersonalization,
                    hasConsentForAdStorage
                );

                AppsFlyerLib.getInstance().setConsentData(consent);
            }

            public MediationNetwork getAFMediationNetwork(int network){
                switch (network) {
                    case 0: return MediationNetwork.IRONSOURCE;
                    case 1: return MediationNetwork.APPLOVIN_MAX;
                    case 2: return MediationNetwork.GOOGLE_ADMOB;
                    case 3: return MediationNetwork.FYBER;
                    case 4: return MediationNetwork.APPODEAL;
                    case 5: return MediationNetwork.ADMOST;
                    case 6: return MediationNetwork.TOPON;
                    case 7: return MediationNetwork.TRADPLUS;
                    case 8: return MediationNetwork.YANDEX;
                    case 9: return MediationNetwork.CHARTBOOST;
                    case 10: return MediationNetwork.UNITY;
                    case 11: return MediationNetwork.CUSTOM_MEDIATION;
                    case 12: return MediationNetwork.DIRECT_MONETIZATION_NETWORK;
                    default: return MediationNetwork.CUSTOM_MEDIATION;
                }
            }
        </insert>
    </gameActivityClassAdditions>
</root>
